<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />

	<title>Svelte app</title>
	<link rel="stylesheet" href="./index.css" />

	<style>
		body {
			margin: 0 0;
		}

		table>thead>tr {
			height: 54px;
		}

		th,
		td {
			border: 1px solid black;
		}

		.item {
			background-color: blue;
			/* margin-top: 2px; */
		}

		.teste3 {
			background-color: red;
		}

		.weekend {
			background-color: brown;
		}
	</style>
</head>

<body>
	<div id="teste"></div>
</body>

<script type="module" src="./index.js"></script>
<script type="module">
	function addDays(date, days) {
		const copy = new Date(Number(date));
		copy.setDate(date.getDate() + days);
		return copy;
	}

	function addHours(date, hours) {
		const copy = new Date(Number(date));
		copy.setHours(copy.getHours() + hours);
		return copy;
	}

	const padding = 30;
	const today = new Date(2020, 3, 1, 0, 0, 0, 0);
	today.setTime(today.getTime() - 3 * 60 * 60 * 1000); //com timezone -3

	let startDate = addDays(today, -padding);
	startDate.setHours(0, 0, 0, 0);
	startDate = startDate.getTime();

	let endDate = addDays(today, padding);
	endDate.setHours(0, 0, 0, 0);
	endDate = endDate.getTime();

	const rows = [
		{
			headers: [
				{
					title: "Item 1",
					content: "abc",
				},
			],
			items: [
				{
					content: "teste",
					title: "teste",
					class: "teste",
					startDate: addDays(today, -1).getTime(),
					endDate: addDays(today, 1).getTime(),
				},
			],
			expanded: false,
			children: [
				{
					headers: [
						{
							content: "SubItem 1",
							title: "sub 1",
						},
					],
					items: [
						{
							details: "teste1",
							startDate: addDays(today, -1).getTime(),
							endDate: addDays(today, -1).getTime(),
						},
					],
				},
				{
					headers: [
						{
							content: "SubItem 2",
							title: "sub 2",
						},
					],
					items: [
						{
							details: "teste2",
							startDate: addDays(today, 0).getTime(),
							endDate: addHours(today, 12).getTime(),
						},
					],
				},
				{
					headers: [
						{
							content: "SubItem 3",
							title: "sub 3",
						},
					],
					items: [
						{
							details: "teste3",
							startDate: addDays(today, 1).getTime(),
							endDate: addDays(today, 1).getTime(),
						},
					],
				},
			],
		},
	];

	const gantt = new Gantt({
		target: document.getElementById("teste"),
		props: {
			formatSlice,
			//slicesSize: 1000 * 60 * 60 * 24 * 365, //1 ano,
			slicesSize: 1000 * 60 * 60 * 24 * 30, //30 dias
			//slicesSize: 1000 * 60 * 60 * 24 * 7, //7 dias
			//slicesSize: 1000 * 60 * 60 * 24 * 1, //1 dia
			//slicesSize: 1000 * 60 * 60 * 1, //1 hora
			startDate,
			endDate,
			header: getHeader(),
			rows,
			zoom: "month"
		},
	});

	gantt.$on('click.item', console.log);
	gantt.$on('click.row', console.log);

	// setTimeout(() => {
	// 	gantt.$set({
	// 		slicesSize: 1000 * 60 * 60 * 12 * 1,
	// 	});
	// 	rows[0].items.push(
	// 		{
	// 			content: "teste3",
	// 			title: "teste3",
	// 			class: "teste3",
	// 			startDate: addDays(today, 1).getTime(),
	// 			endDate: addDays(today, 2).getTime(),
	// 		},
	// 	);
	// 	gantt.$set({ rows });
	// }, 2000);

	function formatSlice(slice) {
		// const day = new Date(slice.startDate).getDay();
		// const isWeekend = (day === 6) || (day === 0);

		return {
			content: slice.startDate + "/" + slice.endDate,
			title: new Date(slice.startDate),
			...slice,
			// class: isWeekend ? "weekend" : ""
		};
	}

	import utils from "./src/utils.js";
	function getHeader() {
		const monthNames = [
			"January",
			"February",
			"March",
			"April",
			"May",
			"June",
			"July",
			"August",
			"September",
			"October",
			"November",
			"December",
		];

		const year = 1000 * 60 * 60 * 24 * 365;
		const month = 1000 * 60 * 60 * 24 * 30;
		const week = 1000 * 60 * 60 * 24 * 7;
		const day = 1000 * 60 * 60 * 24 * 1;
		const hour = 1000 * 60 * 60 * 1;

		return {
			statics: [{
				content: "nome"
			}],
			generate: (row, slices, slicesSize) => {
				let lastDate = new Date(slices[0].startDate);
				lastDate.setYear(lastDate.getFullYear() - 1);
				lastDate.setMonth(lastDate.getMonth() - 1);
				lastDate.setDate(lastDate.getDate() - 8);
				lastDate.setHours(lastDate.getHours() - 1);
				let th = {};

				if (slicesSize >= year) {
					slices.forEach(slice => {
						const currentDate = new Date(slice.startDate);
						if (lastDate.getFullYear() !== currentDate.getFullYear()) {
							th = getColumnHeader();
							row.appendChild(th);
							th.innerHTML = `<div class="header-year">${currentDate.getFullYear()}</div>`;
							row.appendChild(th);
						}
					});
				}
				else if (slicesSize >= month) {
					slices.forEach(slice => {
						const currentDate = new Date(slice.startDate);
						if (lastDate.getFullYear() !== currentDate.getFullYear()) {
							th = getColumnHeader();
							th.setAttribute("colspan", 12 - currentDate.getMonth());
							row.appendChild(th);
							th.innerHTML = `<div class="header-months">${currentDate.getFullYear()}</div>`;
						}
						th.innerHTML += `<span class="header-month">${currentDate.getMonth() + 1}</span>`;
						lastDate = currentDate;
					});
				}
				else if (slicesSize >= day) {
					slices.forEach(slice => {
						const currentDate = new Date(slice.startDate);
						if (lastDate.getMonth() !== currentDate.getMonth()) {
							th = getColumnHeader();
							th.setAttribute("colspan", Math.ceil(utils.getDaysInMonth(currentDate) - currentDate.getDate()) + 1);
							row.appendChild(th);
							th.innerHTML = `<div class="header-days">${currentDate.getMonth() + 1} ${currentDate.getFullYear()}</div>`;
						}
						th.innerHTML += `<span class="header-day">${currentDate.getDate()}</span>`;
						lastDate = currentDate;
					});
				}
				else if (slicesSize >= hour) {
					slices.forEach(slice => {
						const currentDate = new Date(slice.startDate);
						if (lastDate.getDate() !== currentDate.getDate()) {
							th = getColumnHeader();
							th.setAttribute("colspan", 24 - currentDate.getHours());
							row.appendChild(th);
							th.innerHTML = `<div class="header-hours">${currentDate.getDate() + 1} ${currentDate.getMonth() + 1} ${currentDate.getFullYear()}</div>`;
						}
						th.innerHTML += `<span class="header-hour">${currentDate.getHours() + 1}</span>`;
						lastDate = currentDate;
					});
				}
			}
		};
	}

	function getColumnHeader(html) {
		const th = document.createElement("th");
		th.className = "column header slice";
		th.innerHTML = html;
		return th;
	}

	function getGroupsDays(columns) {
		const groups = [];
		let currentGroup;
		let currentMonth = -1;

		columns.forEach(column => {
			const month = column.date.getMonth();

			if (month !== currentMonth) {
				currentGroup = {
					colspan: 1,
					month,
					date: column.date
				};

				groups.push(currentGroup);
				currentMonth = month;
			} else {
				currentGroup.colspan++;
			}
		});

		return groups;
	}
</script>

</html>